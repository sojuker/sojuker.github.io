## 1. Git和分支模型

- 权限管理 》合理授权 owner 、master、develop、reporter 权限，最小授权原则。
- 仓库归属 》创建仓库时，请归属正确的group，各group的含义请自行查看。
- 仓库命名 》采用小写字符和`-`来命名，禁止拼音缩写。
- 分支模型 》关联了发布系统应用的仓库，必须遵守分支模型
  - 最新的稳定代码存放在 `[gitlab]master` 分支上
  - 部署用分支必须命名为 `[gitlab]publish/x.x.x`
  - 部署用分支必须合并过 `[gitlab]master`，才能 `git push` 成功
  - 测试环境部署使用部署用分支的最新commit，线上部署采用预发测试通过的commit
  - 线上发布成功后，该commit会被自动合并入`[gitlab]master`
  - 线上发布成功后，自动生成命名为 `[gitlab]prod_x.x.x` 的 tag
  - 线上发布成功后，自动删除对应的部署用分支，且禁止被重新创建

## 2. 域名规范

- 前端域名的申请，务必需要review，前端域名见[这里](http://zebra.vdian.net/front/index)

| 域名用途        | 域名名称                  | 备注                       |
| ----------- | --------------------- | ---------------------------------------- |
| 前端业务      | *.weidian.com         | h5\fxh5                                  |
| 数据接口      | vap.gw.weidian.com    |                                     |
| 文件流传输     | media.api.weidian.com |                                      |
| websocket   | live.weidian.com      |                                          |
| 静态资源CDN     | assets.geilicdn.com   |                                |
| 静态资源CDN(北京） | s.geilicdn.com        | 杭州没有发布和运维能力，请避免使用    |
| 图片CDN       | si.geilicdn.com       | HTTP域名：wd.geilicdn.com     |
| 图片CDN（老）  | sa.geilicdn.com   | HTTP域名：img.geilicdn.com。<br/>已没有发布能力，请避免使用 |
| 内网应用        | *.vdian.net     |                          |
| 日常/预发环境     | daily.    pre.   | 在域名中添加 daily.  和  pre.  |

## 3. 云端构建

- 云端构建即在云端机上按序执行如下命令

```shell
git clean -df
npm update
npm ls
npm outdated
npm run daily/pre/prod
```

- 基础构建环境

```shell
git   2.7.0
node  v6.9.1
npm   v3.10.8
npm registry http://npm.idcvdian.com/
```

- 云端构建命令规范，<br>![](http://wd.geilicdn.com/4038406a954accd3bb8f2c833c7826ce.png)
- npm包版本管理：开发者务必管理好构建所需npm包的版本，建议锁死版本号或使用 `^语义版本`，[参考这里](https://docs.npmjs.com/files/package.json#dependencies)。
- 选用 npm 包时，请尽量选择测试覆盖率100%且有持续集成的npm包
- 添加 npm 包时，如需使用严格版本号，可以 `npm install xxx --save-dev --save-exact`
- 为避免开发者的npm包版本管理不到位，构建线上包时会跳过 `npm update`（使用上次已安装的npm包）。
- 云端机清空 node_modules：`.gitignore` 中添加 `/node_modules/*` ，会通过 `git clean` 删除 node_modules 目录，只建议日常和预发环境临时使用，否则线上构建会失败。
- npm run scripts 是可编程的，比如 npm run daily 这样写: `git rev-parse --abbrev-ref HEAD && git rev-parse --short HEAD`

## 4. 打包和部署

- 要打包部署的代码存放在对应仓库的 build 目录中（该目录可以由云端构建生成）
- 前端打包内容
  - build目录中有 pages 目录(允许没有)，该目录下文件应打包发布到 server 集群，
  - build目录中有 static 目录(允许没有)，该目录下文件应打包发布到 CDN 集群，
  - 忽略build目录中的其他目录或文件
- hybrid打包内容，[技术方案](http://confluence.vdian.net/pages/viewpage.action?pageId=7345655)
  - build/static 目录，如果不存在，则退出 hybrid 打包流程。
  - manifest.json，自动生成
  - sign.map，自动生成
- hybrid打包的作用
  - 这里的 hybrid 打包其实是指 静态资源离线在APP中，在APP中请求CDN资源时，自动劫持成本地资源并响应。在APP中打开h5页面时，h5引用CDN上静态资源的请求会被拦截，并使用 hybrid 包中的内容进行响应，提升网络性能。

## 5. 发布流程

- ![](http://wd.geilicdn.com/cdae764ef1589c5151721cf0095f235c.png)
- ![](http://wd.geilicdn.com/b92fcf680a4e6898fa753e5726daf648.png)
- ![](https://si.geilicdn.com/hz_img_1019000001594db3589a0a026860_806_1071_unadjust.png)
- ![](https://si.geilicdn.com/7012221a72f34a6a60f8356da8ef7f5e.png)
- ![](https://si.geilicdn.com/hz_img_05b6000001594d9b7fa40a02685e_1071_806_unadjust.png)

## 6. HTTP配置


- 动静分离
  - 静态内容，是指同一个URL，不管何时、任意次数进行请求，响应的内容总是一致的。
- 动态内容发布至动态服务器
    - 强制HTTP缓存协商，配置 `cache-control:no-cache` + `last-modified`，无 `e-tag`(某些场景同一内容在不同服务器上e-tag不一致)
- 静态内容发布至CDN(也包含图片发布到图片CDN)
    - 配置 `cache-control:max-age`，请处理好缓存更新与失效问题，[不懂请阅读](http://div.io/topic/745)
    - 配置 `cache-control:s-max-age`，用于响应头更新
    - 配置 `access-control-allow-origin:*`，支持跨域
    - 配置 `timing-allow-origin:*`，支持跨域性能信息获取
- 后端数据接口
    - 配置 Access-Control-Allow 相关字段，只支持 *.weidian.com
    - referrer 限制，只允许 *.weidian.com 的 referrer，防安全
- Referrer规范：暂无处理
- CSP规范：详细见前端数据化
- X-Frame-Options：暂无处理
- HTTPS 配置，提升安全和性能
  - 开启 SPDY3.1 和 HTTP2 支持
  - 开启会话复用（Session Resume）
  - 配置完整的证书链（certificate chain）
  - 开启 OCSP stapling，已关闭
  - 开启 HSTS（HTTP Strict Transport Security）
- 前后端(h5-vap)跨域原则
  - 本地前端环境，<span style="font-weight:bold">h5.dev.weidian.com</span>，能跨域访问 vap 各套环境，以便于开发联调用。
  - 对应前端环境，支持跨域访问对应 vap 环境，以支持主流程和主场景。
  - 任何前端环境，都支持跨域访问线上 vap 环境，使得引用前端公共组件时，可直接引用线上版稳定的公共组件。
  - 不可降级跨域访问，高级前端环境不能跨域到低级的vap环境，避免控制混乱，问题定位复杂度大幅度提升。

## 7. 自助数据分析-kibaba

- <http://log.vdian.net/app/kibana#/discover/zyq-a-demo>

## 8. 应用下线流程

- 由于业务变动，某些应用会需要及时下线。此时要做好以下工作，以确保无后患。
- 降低该应用的访问量，达成3天内极少访问量，或 302 重定向至新应用。
- 删除在发布系统中的对应应用，封存与应用关联的仓库。

## 附录，参考图

![](http://wd.geilicdn.com/d97dc711e22ec1c5d7cb86292e5acf57.png)
![](http://wd.geilicdn.com/666538a08eb70b5f0c1ee8c30a4fe90e.jpg)