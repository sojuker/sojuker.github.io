DOM defines a platform-neutral model for events and node trees.
DOM4 adds Mutation Observers as a replacement for Mutation Events.

## Terminology

- context object
- A tree is a finite hierarchical tree structure
- `In tree order` is preorder, depth-first traversal of a tree.
- parent/child, root, descendant/ancestor, sibling, preceding/following

## Events

Throughout the web platform,
events are dispatched to objects to signal an occurrence, such as network activity or user interaction.
These objects implement the EventTarget interface and can therefore add event listeners to observe events by calling addEventListener().
Events are objects too and implement the Event interface (or a derived interface).
Applications can also dispatch events themselves, commonly known as synthetic events.

`interface Event`

> As events have constructors, initEvent() is superfluous.
> However, it has to be supported for legacy content.

`interface EventTarget`

EventTarget is an object to which an event is dispatched when something has occurred.
Each EventTarget has an associated list of event listeners.
Each event listener consists of a type (of the event), callback, and capture variable.

`dispatch Event`

`fire an Event` --> isTrusted true

To fire an event named e means that a new event using the Event interface,
with its type attribute initialized to e, and `its isTrusted attribute initialized to true`,
is to be dispatched to the given object.

## Nodes

A node tree is constrained as follows, expressed as a relationship between the type of node and its allowed children.

...

A collection is an object that represents a lists of DOM nodes.
A collection can be either live or static. Unless otherwise stated, a collection must be live.

If a collection is live, then the attributes and methods on that object must operate on the actual underlying data, not a snapshot of the data.

When a collection is created, a filter and a root are associated with it.
The collection then represents a view of the subtree rooted at the collection's root, containing only nodes that match the given filter.
The view is linear. In the absence of specific requirements, the nodes within the collection must be sorted in tree order.

> A NodeList object is a collection of nodes.

> An HTMLCollection object is a collection of elements.

## Mutation observers

Each `unit of related similar-origin browsing contexts` has a mutation observer compound microtask `queued flag`
and an associated list of MutationObserver objects which is initially empty.

Each node has an associated list of registered observers.
A registered observer consists of an observer (a MutationObserver object) and options (a MutationObserverInit dictionary).
A transient registered observer is a specific type of registered observer that has a `source` which is a registered observer.

The MutationObserver(callback) constructor must create a new MutationObserver object with callback set to callback,
append it to the unit of related similar-origin browsing contexts's list of MutationObserver objects, and then return it.

Queuing a mutation record
    - Queue a mutation observer compound microtask

Nodes have a strong reference to registered observers in their list of registered observers.

Registered observers in a node's list of registered observers have a weak reference to the node.

## unit of related similar-origin browsing contexts

Each browsing context is defined as having a list of one or more directly reachable browsing contexts. These are:
- The browsing context itself.
- All the browsing context's child browsing contexts.
- The browsing context's parent browsing context.
- All the browsing contexts that have the browsing context as their opener browsing context.
- The browsing context's opener browsing context.

The transitive closure of all the browsing contexts that are directly reachable browsing contexts forms a unit of `related browsing contexts`.

Each unit of related browsing contexts is then further divided into the smallest number of groups
such that every member of each group has an active document with `an effective script origin` that,
through appropriate manipulation of the document.domain attribute(端口是没有关系的，但协议似乎有关系的),
could be made to be the same as other members of the group,
but could not be made the same as members of any other group.
Each such group is a unit of related similar-origin browsing contexts.

> There is also at most one event loop per unit of related similar-origin browsing contexts (though several units of related similar-origin browsing contexts can have a shared event loop).

There must be at least one event loop per user agent, and at most one event loop per unit of related similar-origin browsing contexts.